<%@ jet 
imports="
	org.talend.designer.codegen.config.CodeGeneratorArgument
	org.talend.core.model.process.INode
	org.talend.core.model.process.ElementParameterParser
"
%>

<%
CodeGeneratorArgument codeGenArgument = (CodeGeneratorArgument) argument;
INode node = (INode) codeGenArgument.getArgument();
String cid = node.getUniqueName();

String dataAction = ElementParameterParser.getValue(node, "__DATA_ACTION__");
String commitEvery = ElementParameterParser.getValue(node, "__COMMIT_EVERY__");


// Close SQL statements
if(dataAction.equals("INSERT_OR_UPDATE")) {
    %>
    if(pstmtUpdate_<%=cid%> != null){

        pstmtUpdate_<%=cid %>.close();
        
    } 
    if(pstmtInsert_<%=cid %> != null){

        pstmtInsert_<%=cid %>.close();
        
    }
    if(pstmt_<%=cid %> != null) {

        pstmt_<%=cid %>.close();
        
    }        
    <%
} else if(dataAction.equals("UPDATE_OR_INSERT")) {
    %>
    if(pstmtUpdate_<%=cid%> != null){

        pstmtUpdate_<%=cid %>.close();
        
    } 
    if(pstmtInsert_<%=cid %> != null){

        pstmtInsert_<%=cid %>.close();
        
    }        
    <%
} else {
    %>
    if(pstmt_<%=cid %> != null) {

        pstmt_<%=cid %>.close();
        
    }        
    <%
}
%>

<%
String useExistingConn = ElementParameterParser.getValue(node,"__USE_EXISTING_CONNECTION__");
if(useExistingConn.equals("false")){
	// Commit if needed
	if (!commitEvery.equals("") && !commitEvery.equals("0")) {
	    %>
	    connection_<%=cid%>.commit();
	    <%
	}
	%>
	connection_<%=cid%>.close();
	resourceMap.put("finish_<%=cid%>", true);
	<%
}
%>

nb_line_deleted_<%=cid%>=nb_line_deleted_<%=cid%> + deletedCount_<%=cid%>;
nb_line_update_<%=cid%>=nb_line_update_<%=cid%> + updatedCount_<%=cid%>;
nb_line_inserted_<%=cid%>=nb_line_inserted_<%=cid%> + insertedCount_<%=cid%>;

globalMap.put("<%=cid%>_NB_LINE", nb_line_<%=cid%>);
globalMap.put("<%=cid%>_NB_LINE_UPDATED", nb_line_update_<%=cid%>);
globalMap.put("<%=cid%>_NB_LINE_INSERTED", nb_line_inserted_<%=cid%>);
globalMap.put("<%=cid%>_NB_LINE_DELETED", nb_line_deleted_<%=cid%>);
globalMap.put("<%=cid %>_NB_LINE_REJECTED",nb_line_rejected_<%=cid%>);
