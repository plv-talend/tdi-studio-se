<%@ jet 
imports="
    	org.talend.designer.codegen.config.CodeGeneratorArgument
		org.talend.core.model.process.INode
		org.talend.core.model.process.ElementParameterParser  
		org.talend.core.model.metadata.IMetadataTable 
	    org.talend.core.model.metadata.MappingTypeRetriever
	    org.talend.core.model.metadata.MetadataTalendType	    
		java.util.List
		java.util.ArrayList
		java.util.Map
		java.util.HashMap
" 
skeleton="../templates/db_output_bulk.skeleton"
%>
<%@ include file="../templates/Log4j/Log4jDBConnUtil.javajet"%>

<%
	CodeGeneratorArgument codeGenArgument = (CodeGeneratorArgument) argument;
	INode node = (INode)codeGenArgument.getArgument();
	String cid = node.getUniqueName();
	String dbtypeDefinition = ElementParameterParser.getValue(node, "__TYPE__");
    List<Map<String, String>> addCols = (List<Map<String,String>>)ElementParameterParser.getObjectValue(node,"__ADD_COLS__" );
    boolean useFieldOptions = ("true").equals(ElementParameterParser.getValue(node, "__USE_FIELD_OPTIONS__"));
    List<Map<String, String>> fieldOptions = (List<Map<String,String>>)ElementParameterParser.getObjectValue(node, "__FIELD_OPTIONS__");
    String dbname= ElementParameterParser.getValue(node, "__DBNAME__");
    String dbproperties = ElementParameterParser.getValue(node, "__PROPERTIES__");
    String dbhost = ElementParameterParser.getValue(node, "__HOST__");
	String dbport = ElementParameterParser.getValue(node, "__PORT__");
	String dbuser= ElementParameterParser.getValue(node, "__USER__");
	String tableName = ElementParameterParser.getValue(node,"__TABLE__");
	String dbmsId = ElementParameterParser.getValue(node,"__MAPPING__");
	String dataAction = ElementParameterParser.getValue(node,"__DATA_ACTION__");
	String tableAction = ElementParameterParser.getValue(node,"__TABLE_ACTION__");
	String commitEvery = ElementParameterParser.getValue(node, "__COMMIT_EVERY__");
	boolean useBatchSize = ("true").equals(ElementParameterParser.getValue(node,"__USE_BATCH_SIZE__"));
	String batchSize=ElementParameterParser.getValue(node,"__BATCH_SIZE__");
	
	boolean isLog4jEnabled = ("true").equals(ElementParameterParser.getValue(node.getProcess(), "__LOG4J_ACTIVATE__"));
	log4jCodeGenerateUtil.infoComponentStart(node);
	log4jCodeGenerateUtil.initDbDebugRowBuffer();	
	boolean isParallelize ="true".equalsIgnoreCase(ElementParameterParser.getValue(node, "__PARALLELIZE__"));
%>

<%
getManager(dbmsId, cid, node);

List<IMetadataColumn> columnList = getColumnList(node);
List<Column> stmtStructure = null;
if(columnList != null && columnList.size() > 0) {
    stmtStructure = getManager(dbmsId, cid).createColumnList(columnList, useFieldOptions, fieldOptions, addCols);
}
%>

<%
if(("UPDATE").equals(dataAction) || ("INSERT_OR_UPDATE").equals(dataAction) || ("UPDATE_OR_INSERT").equals(dataAction)) {
    int updateKeyCount = 0;
    if(stmtStructure != null) {
        for(Column column : stmtStructure) {
            if(column.isUpdateKey()) {
                updateKeyCount++;
            }
        }
        %>
        int updateKeyCount_<%=cid%> = <%=updateKeyCount%>;
        if(updateKeyCount_<%=cid%> < 1) {
			<%if(isLog4jEnabled){%>
				log.fatal("<%=cid%> - For update ,Shcema must have a key");
			<%}%>	
            throw new RuntimeException("For update, Schema must have a key");
        }
        <%
    }
} else if(("DELETE").equals(dataAction)) {
    int deleteKeyCount = 0;
    if(stmtStructure != null) {
        for(Column column : stmtStructure) {
            if(column.isDeleteKey()) {
                deleteKeyCount++;
            }
        }
        %>
        int deleteKeyCount_<%=cid%> = <%=deleteKeyCount%>;
        if(deleteKeyCount_<%=cid%> < 1) {
			<%if(isLog4jEnabled){%>
				log.fatal("<%=cid%> - For delete ,Shcema must have a key");
			<%}%>	
            throw new RuntimeException("For delete, Schema must have a key");
        }
        <%
    }
}
%> 

int nb_line_<%=cid%> = 0;
int nb_line_update_<%=cid%> = 0;
int nb_line_inserted_<%=cid%> = 0;
int nb_line_deleted_<%=cid%> = 0;
int nb_line_rejected_<%=cid%> = 0;

int deletedCount_<%=cid%>=0;
int updatedCount_<%=cid%>=0;
int insertedCount_<%=cid%>=0;
int rejectedCount_<%=cid%>=0;

String tableName_<%=cid%> = <%=tableName%>;
boolean whetherReject_<%=cid%> = false;

java.util.Calendar calendar_<%=cid %> = java.util.Calendar.getInstance();
calendar_<%=cid %>.set(1, 0, 1, 0, 0, 0);
long year1_<%=cid %> = calendar_<%=cid %>.getTime().getTime();
calendar_<%=cid %>.set(10000, 0, 1, 0, 0, 0);
long year10000_<%=cid %> = calendar_<%=cid %>.getTime().getTime();
long date_<%=cid %>;

java.sql.Connection conn_<%=cid%> = null;
<%
String useExistingConn = ElementParameterParser.getValue(node,"__USE_EXISTING_CONNECTION__");
if(("true").equals(useExistingConn))
{
	commitEvery = "0";
	String connection = ElementParameterParser.getValue(node,"__CONNECTION__");
	String conn = "conn_" + connection;
	%>
	conn_<%=cid%> = (java.sql.Connection)globalMap.get("<%=conn%>");
	<%if(isLog4jEnabled){%>	
		if(conn_<%=cid%> != null) {
			if(conn_<%=cid%>.getMetaData() != null) {
				log.info("<%=cid%> - Uses an existing connection as " + conn_<%=cid%>.getMetaData().getUserName() + ". Connection URL: " + conn_<%=cid%>.getMetaData().getURL() + ".");
			}
		}
	<%}%>
	<%
}
else
{
	%>
	String driverClass_<%=cid%> = "org.netezza.Driver";
	java.lang.Class.forName(driverClass_<%=cid%>);
	<%
	if(dbproperties == null || ("\"\"").equals(dbproperties) || ("").equals(dbproperties)) {
	    %>
	    String url_<%=cid%> = "jdbc:netezza://" + <%=dbhost%> + ":" + <%=dbport%> + "/" + <%=dbname%>;
	    <%
	} else {
	    %>
	    String url_<%=cid%> = "jdbc:netezza://" + <%=dbhost%> + ":" + <%=dbport%> + "/" + <%=dbname%> + "?" + <%=dbproperties%>;
	    <%
	}	
	%>
	String dbUser_<%=cid %> = <%=dbuser%>;
	<%
	String passwordFieldName = "__PASS__";
	%>

	<%@ include file="@{org.talend.designer.components.localprovider}/components/templates/password.javajet"%>

	String dbPwd_<%=cid %> = decryptedPassword_<%=cid%>;
	<%
   		log4jCodeGenerateUtil.debugConnectionParams(node);	
	%>
	<%log4jCodeGenerateUtil.connect();%>
	resourceMap.put("conn_<%=cid%>", conn_<%=cid%>);
	<%
}	

if(columnList != null && columnList.size() > 0) {
    if(!isParallelize && !("NONE").equals(tableAction)) {
        Manager manager = getManager(dbmsId, cid);
        if(("DROP_CREATE").equals(tableAction)) {
            %>
            java.sql.Statement stmtDrop_<%=cid%> = conn_<%=cid%>.createStatement();
        	<%if(isLog4jEnabled){%>
				log.info("<%=cid%> - Droping table '" + tableName_<%=cid%> + "'.");
			<%}%>
            stmtDrop_<%=cid%>.execute("<%=manager.getDropTableSQL()%>");
        	<%if(isLog4jEnabled){%>
				log.info("<%=cid%> - Drop table '" + tableName_<%=cid%> + "' has succeeded.");
			<%}%>
            java.sql.Statement stmtCreate_<%=cid%> = conn_<%=cid%>.createStatement();
        	<%if(isLog4jEnabled){%>
				log.info("<%=cid%> - Creating table '" + tableName_<%=cid%> + "'.");
			<%}%>
            stmtCreate_<%=cid%>.execute("<%=manager.getCreateTableSQL(stmtStructure)%>)");
        	<%if(isLog4jEnabled){%>
				log.info("<%=cid%> - Create table '" + tableName_<%=cid%> + "' has succeeded.");
			<%}%>
            <%
        } else if(("CREATE").equals(tableAction)) {
            %>
            java.sql.Statement stmtCreate_<%=cid%> = conn_<%=cid%>.createStatement();
        	<%if(isLog4jEnabled){%>
				log.info("<%=cid%> - Creating table '" + tableName_<%=cid%> + "'.");
			<%}%>
            stmtCreate_<%=cid%>.execute("<%=manager.getCreateTableSQL(stmtStructure)%>)");
        	<%if(isLog4jEnabled){%>
				log.info("<%=cid%> - Creata table '" + tableName_<%=cid%> + "' has succeeded.");
			<%}%>
            <%
        } else if(("CREATE_IF_NOT_EXISTS").equals(tableAction) || ("DROP_IF_EXISTS_AND_CREATE").equals(tableAction)) {
            %>
            java.sql.DatabaseMetaData dbMetaData_<%=cid%> = conn_<%=cid%>.getMetaData();
            java.sql.ResultSet rsTable_<%=cid%> = dbMetaData_<%=cid%>.getTables(null, null, null, new String[]{"TABLE"});
            boolean whetherExist_<%=cid%> = false;
            while(rsTable_<%=cid%>.next()) {
                String table_<%=cid%> = rsTable_<%=cid%>.getString("TABLE_NAME");
                if(table_<%=cid%>.equalsIgnoreCase(<%=tableName%>)) {
                    whetherExist_<%=cid%> = true;
                    break;
                }
            }
            <%
            if(("CREATE_IF_NOT_EXISTS").equals(tableAction)) {
                %>
                if(!whetherExist_<%=cid%>) {
                    java.sql.Statement stmtCreate_<%=cid%> = conn_<%=cid%>.createStatement();
		        	<%if(isLog4jEnabled){%>
						log.info("<%=cid%> - Creating table '" + tableName_<%=cid%> + "'.");
					<%}%>
		            stmtCreate_<%=cid%>.execute("<%=manager.getCreateTableSQL(stmtStructure)%>)");
		        	<%if(isLog4jEnabled){%>
						log.info("<%=cid%> - Create table '" + tableName_<%=cid%> + "' has succeeded.");
					<%}%>          
                }                
                <%
            } else {
                %>
                if(whetherExist_<%=cid%>) {
                    java.sql.Statement stmtDrop_<%=cid%> = conn_<%=cid%>.createStatement();
		        	<%if(isLog4jEnabled){%>
						log.info("<%=cid%> - Droping tableName_<%=cid%>!");
					<%}%>
                    stmtDrop_<%=cid%>.execute("<%=manager.getDropTableSQL()%>");
		        	<%if(isLog4jEnabled){%>
						log.info("<%=cid%> - Drop table '" + tableName_<%=cid%> + "' has succeeded.");
					<%}%>
                }
                java.sql.Statement stmtCreate_<%=cid%> = conn_<%=cid%>.createStatement();
	        	<%if(isLog4jEnabled){%>
					log.info("<%=cid%> - Creating table '" + tableName_<%=cid%> + "'.");
				<%}%>
                stmtCreate_<%=cid%>.execute("<%=manager.getCreateTableSQL(stmtStructure)%>)");
	        	<%if(isLog4jEnabled){%>
					log.info("<%=cid%> - Create table '" + tableName_<%=cid%> + "' has succeeded.");
				<%}%>
            <%
            }
        } else if(("TRUNCATE").equals(tableAction)) {
            %>
            java.sql.Statement stmtClearCount_<%=cid%> = conn_<%=cid%>.createStatement();
            java.sql.ResultSet rsClearCount_<%=cid%> = stmtClearCount_<%=cid%>.executeQuery("<%=manager.getSelectionSQL()%>");
            java.sql.Statement stmtClear_<%=cid%> = conn_<%=cid%>.createStatement();
			<%if(isLog4jEnabled){%>
				log.info("<%=cid%> - Truncating table '" + tableName_<%=cid%> + "'.");
			<%}%>
            stmtClear_<%=cid%>.executeUpdate("<%=manager.getTruncateTableSQL()%>");
			<%if(isLog4jEnabled){%>
				log.info("<%=cid%> - Truncate table '" + tableName_<%=cid%> + "' has succeeded.");
			<%}%>
            while(rsClearCount_<%=cid%>.next()) {
                deletedCount_<%=cid%> += rsClearCount_<%=cid%>.getInt(1);
            }
            <% 
        } else if (("CLEAR").equals(tableAction)){
            %>
            java.sql.Statement stmtClear_<%=cid%> = conn_<%=cid%>.createStatement();
            <%if(isLog4jEnabled){%>
				log.info("<%=cid%> - Clearing table '" + tableName_<%=cid%> + "'.");
			<%}%>
            deletedCount_<%=cid%> = deletedCount_<%=cid%> + stmtClear_<%=cid%>.executeUpdate("<%=manager.getDeleteTableSQL()%>");
			<%if(isLog4jEnabled){%>
				log.info("<%=cid%> - Clear table '" + tableName_<%=cid%> + "' has succeeded.");
			<%}%>
            stmtClear_<%=cid%>.close();
            <%
        }
    }
    Map<String, StringBuilder> actionSQLMap = getManager(dbmsId, cid).createProcessSQL(stmtStructure);
    StringBuilder insertColName = actionSQLMap.get(INSERT_COLUMN_NAME);   
    StringBuilder insertValueStmt = actionSQLMap.get(INSERT_VALUE_STMT);    
    StringBuilder updateSetStmt = actionSQLMap.get(UPDATE_SET_STMT);    
    StringBuilder updateWhereStmt = actionSQLMap.get(UPDATE_WHERE_STMT);
    StringBuilder deleteWhereStmt = actionSQLMap.get(DELETE_WHERE_STMT);
    
    if(!("true").equals(useExistingConn)){
    %>
    	conn_<%=cid%>.setAutoCommit(false);
    <%
    }
	if(("INSERT").equals(dataAction)){
	        %>      	    
	        java.sql.PreparedStatement pstmt_<%=cid %> = conn_<%=cid%>.prepareStatement("INSERT INTO "+<%=tableName%>+" (<%=insertColName.toString()%>) VALUES (<%=insertValueStmt.toString()%>)");	        
	        <%
	}else if (("UPDATE").equals(dataAction)){
	    %>
	
	    java.sql.PreparedStatement pstmt_<%=cid %> = conn_<%=cid%>.prepareStatement("UPDATE " + <%=tableName%> + " SET <%=updateSetStmt.toString()%> WHERE <%=updateWhereStmt.toString()%>");

	    <%		
	}else if (("INSERT_OR_UPDATE").equals(dataAction)){
	    %>
	    java.sql.PreparedStatement pstmt_<%=cid %> = conn_<%=cid%>.prepareStatement("SELECT COUNT(1) FROM " + <%=tableName%> + " WHERE <%=updateWhereStmt.toString()%>");	

	    java.sql.PreparedStatement pstmtInsert_<%=cid %> = conn_<%=cid%>.prepareStatement("INSERT INTO " + <%=tableName%> + " (<%=insertColName.toString()%>) VALUES (<%=insertValueStmt.toString()%>)");

	    java.sql.PreparedStatement pstmtUpdate_<%=cid %> = conn_<%=cid%>.prepareStatement("UPDATE " + <%=tableName%> + " SET <%=updateSetStmt.toString()%> WHERE <%=updateWhereStmt.toString()%>");
		
	    <%
	}else if (("UPDATE_OR_INSERT").equals(dataAction)){
	    %>
	    java.sql.PreparedStatement pstmtUpdate_<%=cid %> = conn_<%=cid%>.prepareStatement("UPDATE " + <%=tableName%> + " SET <%=updateSetStmt.toString()%> WHERE <%=updateWhereStmt.toString()%>");


	    java.sql.PreparedStatement pstmtInsert_<%=cid %> = conn_<%=cid%>.prepareStatement("INSERT INTO " + <%=tableName%> + " (<%=insertColName.toString()%>) VALUES (<%=insertValueStmt.toString()%>)");
				
	    <%
			
	}else if (("DELETE").equals(dataAction)){
	    %>
	
	    java.sql.PreparedStatement pstmt_<%=cid %> = conn_<%=cid%>.prepareStatement("DELETE  FROM " + <%=tableName%> + " WHERE <%=deleteWhereStmt.toString()%>");

	    <%		
	}

	if(!("").equals(commitEvery)&&!("0").equals(commitEvery)){
	    %>

	    int commitEvery_<%=cid%> = <%=commitEvery%>;

	    int commitCounter_<%=cid%> = 0;

	<%
	}
	if (useBatchSize ) {
    if(!("").equals(batchSize)&&!("0").equals(batchSize)) {
%>
	   int batchSize_<%=cid%> = <%=batchSize%>;
	   int batchSizeCounter_<%=cid%>=0;
<%   
   }
}
}
%>
